# Load HSBC certificates
$rootCertPath = "C:\home\site\wwwroot\Certs\labubu_root_SHA2.cer"
$intermediateCertPath = "C:\home\site\wwwroot\Certs\labubu_SHA2_inter.cer"

$rootCert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($rootCertPath)
$intermediateCert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($intermediateCertPath)

# Create handler
$handler = New-Object System.Net.Http.HttpClientHandler

$handler.ServerCertificateCustomValidationCallback = {
    param($request, $cert, $chain, $errors)

    Write-Host "Custom SSL validation started..."

    $customChain = New-Object System.Security.Cryptography.X509Certificates.X509Chain
    $customChain.ChainPolicy.ExtraStore.Add($intermediateCert)
    $customChain.ChainPolicy.ExtraStore.Add($rootCert)

    $customChain.ChainPolicy.VerificationFlags = [System.Security.Cryptography.X509Certificates.X509VerificationFlags]::AllowUnknownCertificateAuthority
    $customChain.ChainPolicy.RevocationMode = [System.Security.Cryptography.X509Certificates.X509RevocationMode]::NoCheck

    $isValid = $customChain.Build($cert)

    if ($isValid) {
        Write-Host "SSL validation successful using HSBC CA"
        return $true
    }
    else {
        Write-Host "SSL validation failed"
        return $false
    }
}

$client = New-Object System.Net.Http.HttpClient($handler)
$response = $client.GetAsync($uri).GetAwaiter().GetResult()
