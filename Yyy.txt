# Path to your private CA certificate
$caPath = "/home/site/wwwroot/Certs/CA.cer"

# Load the CA certificate
$caCert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($caPath)

# Create custom HttpClientHandler
$handler = New-Object System.Net.Http.HttpClientHandler

$handler.ServerCertificateCustomValidationCallback = {
    param($request, $cert, $chain, $errors)

    # Build a new chain using our custom CA
    $customChain = New-Object System.Security.Cryptography.X509Certificates.X509Chain
    $customChain.ChainPolicy.ExtraStore.Add($caCert)
    $customChain.ChainPolicy.RevocationMode = [System.Security.Cryptography.X509Certificates.X509RevocationMode]::NoCheck
    $customChain.ChainPolicy.VerificationFlags = [System.Security.Cryptography.X509Certificates.X509VerificationFlags]::AllowUnknownCertificateAuthority

    $isValid = $customChain.Build($cert)

    return $isValid
}

# Create HttpClient using custom handler
$client = New-Object System.Net.Http.HttpClient($handler)

# Make request
$response = $client.GetAsync($uri).Result
$content = $response.Content.ReadAsStringAsync().Result

Write-Output $content
