# ===== Custom HttpClient for PowerShell 7 (Bypass Private CA) =====

Add-Type @"
using System.Net.Http;
using System.Net.Security;
using System.Security.Cryptography.X509Certificates;

public class UnsafeHttpHandler : HttpClientHandler
{
    public UnsafeHttpHandler()
    {
        ServerCertificateCustomValidationCallback =
            HttpClientHandler.DangerousAcceptAnyServerCertificateValidator;
    }
}
"@

$handler = [UnsafeHttpHandler]::new()
$client  = [System.Net.Http.HttpClient]::new($handler)

# Add headers
$client.DefaultRequestHeaders.Clear()
$client.DefaultRequestHeaders.Add("Authorization", "Basic $encoded")
$client.DefaultRequestHeaders.Add("Accept", "application/json")

try {
    Write-Host "Calling API: $uri"

    $httpResponse = $client.GetAsync($uri).GetAwaiter().GetResult()

    if (-not $httpResponse.IsSuccessStatusCode) {
        throw "Request failed: $($httpResponse.StatusCode)"
    }

    $content = $httpResponse.Content.ReadAsStringAsync().GetAwaiter().GetResult()
    $response = $content | ConvertFrom-Json
}
catch {
    Write-Host "API call failed"
    Write-Host $_
    throw
}

# ================================================================
