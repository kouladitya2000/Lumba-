Import-Module Az.ResourceGraph

# Get all subscriptions from Azure
$subs = Get-AzSubscription

$FilteredSubs = foreach ($sub in $subs) {

    $subId = $sub.Id

    # Query resource graph
    $result = Search-AzGraph -Query @"
resourcecontainers
| where type == 'microsoft.resources/subscriptions'
| where properties.subscriptionId == '$subId'
| extend Parent = properties.managementGroupAncestorsChain[0]
| project subscriptionId = tostring(properties.subscriptionId),
          subscriptionName = tostring(name),
          parentMG = tolower(tostring(Parent.properties.displayName))
"@

    # If nothing returned, skip
    if (-not $result) { continue }

    $parentMG = $result.parentMG

    # Skip subscriptions with parent MG having "decommissioned" (case-insensitive)
    if ($parentMG -like "*decommissioned*") {
        Write-Host "IGNORED: $($result.subscriptionName) â†’ Parent MG: $parentMG"
        continue
    }

    # Return only valid subscriptions
    $sub
}

Write-Host ""
Write-Host "============== FINAL SUBSCRIPTIONS =============="
$FilteredSubs | Select-Object Name, Id | Format-Table
