# This query returns subscription + its immediate parent MG only
$query = @"
resourcecontainers
| where type == 'microsoft.resources/subscriptions'
| extend chain = properties.managementGroupAncestorsChain
| mv-expand anc = chain
| where anc.properties.level == 1        // immediate parent ONLY
| project subscriptionId = tostring(properties.subscriptionId),
          subscriptionName = tostring(name),
          parentMGName = tostring(anc.name),
          parentMGDisplayName = tostring(anc.properties.displayName)
"@

$allSubsWithParents = Search-AzGraph -Query $query

# Filter out the ones with parent MG containing "decommissioned"
$filtered = $allSubsWithParents | Where-Object {
    $_.parentMGDisplayName -notmatch "decommissioned"
}

# Show what will be IGNORED
$ignored = $allSubsWithParents | Where-Object {
    $_.parentMGDisplayName -match "decommissioned"
}

Write-Host "----- Ignored Subscriptions (Parent MG: Decommissioned) -----`n"
$ignored | Format-Table subscriptionId, subscriptionName, parentMGDisplayName -AutoSize

Write-Host "`n----- FINAL SUBSCRIPTIONS TO PROCESS -----`n"
$filtered | Format-Table subscriptionId, subscriptionName, parentMGDisplayName -AutoSize
