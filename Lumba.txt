Import-Module Az.ResourceGraph

$subs = Get-AzSubscription

$FilteredSubs = foreach ($sub in $subs) {

    $subId = $sub.Id

    $result = Search-AzGraph -Query @"
resourcecontainers
| where type == 'microsoft.resources/subscriptions'
| where subscriptionId == '$subId'
| extend chain = properties.managementGroupAncestorsChain
| extend parentMG = tostring(chain[0].displayName)
| project subscriptionId = tostring(subscriptionId),
          subscriptionName = tostring(name),
          parentMG
"@

    if (-not $result) { continue }

    $parent = $result.parentMG.ToLower()

    if ($parent -like "*decommissioned*") {
        Write-Host "IGNORED: $($result.subscriptionName) â†’ Parent: $parent"
        continue
    }

    # Keep this subscription
    $sub
}

Write-Host ""
Write-Host "============== FINAL SUBSCRIPTIONS (AFTER FILTER) =============="
$FilteredSubs | Select-Object Name, Id | Format-Table
